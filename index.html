<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Flappy Trym To By PmN</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
  margin:0;
  width:100%;
  height:100%;
  overflow:hidden;
  background:#000;
  user-select:none;
  touch-action:manipulation;
  font-family:sans-serif;
}

#game{
  position:relative;
  width:100vw;
  height:100vh;
  overflow:hidden;
  background:url("bg.png") repeat-x;
  background-size:auto 100%;
}

/* Flash ƒë·ªè khi va ch·∫°m */
#game.hit{
  animation:flash .15s linear 2;
}
@keyframes flash{
  0%{filter:none}
  50%{filter:brightness(1.6) sepia(1) hue-rotate(-20deg)}
  100%{filter:none}
}

/* Chim */
#bird{
  position:absolute;
  width:34px;
  height:24px;
  left:15vw;
  top:40vh;
  background:url("bird.png") no-repeat;
  background-size:100% 100%;
}

/* Chim rung khi ch·∫øt */
#bird.dead{
  animation:shake .4s;
}
@keyframes shake{
  0%{transform:translate(0)}
  25%{transform:translate(-3px,2px)}
  50%{transform:translate(3px,-2px)}
  75%{transform:translate(-2px,2px)}
  100%{transform:translate(0)}
}

/* ·ªêng */
.pipe{
  position:absolute;
  width:52px;
  background:url("pipe.png") repeat-y;
  background-size:52px auto;
}
.pipe.top{ top:0; transform:rotate(180deg); }
.pipe.bottom{ bottom:112px; }

/* ƒê·∫•t */
#ground{
  position:absolute;
  bottom:0;
  width:200%;
  height:112px;
  background:url("ground.png") repeat-x;
  background-size:auto 112px;
}

/* ƒêi·ªÉm */
#score{
  position:absolute;
  top:16px;
  left:50%;
  transform:translateX(-50%);
  font-size:32px;
  color:#fff;
  font-weight:bold;
  text-shadow:2px 2px 4px #000;
  z-index:10;
}

/* Overlay */
#overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:20;
}

#panel{
  background:#fff;
  padding:22px 30px;
  border-radius:14px;
  text-align:center;
}
#panel button{
  padding:10px 26px;
  font-size:16px;
  border:none;
  border-radius:8px;
  background:#ffcc00;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="game">
  <div id="score"></div>
  <div id="bird"></div>
  <div id="ground"></div>

  <div id="overlay">
    <div id="panel">
      <h2 id="title">Flappy Trym</h2>
      <p id="finalScore"></p>
      <button id="actionBtn">B·∫ÆT ƒê·∫¶U CH∆†I TRYM</button>
    </div>
  </div>
</div>

<script>
  const bgMusic = new Audio("music.mp3");
bgMusic.loop = true;
bgMusic.volume = 0.9;
const game = document.getElementById("game");
const bird = document.getElementById("bird");
const ground = document.getElementById("ground");
const scoreEl = document.getElementById("score");
const overlay = document.getElementById("overlay");
const finalScore = document.getElementById("finalScore");
const title = document.getElementById("title");
const actionBtn = document.getElementById("actionBtn");

let birdY, velocity, score, best;
let pipeSpeed, gapRatio, groundX;
let pipes = [];
let started = false;
let gameOver = false;
let pipeTimer;

function init(){
  birdY = innerHeight * 0.4;
  velocity = 0;
  score = 0;
  best = localStorage.getItem("bestScore") || 0;
  pipeSpeed = 3;
  gapRatio = 0.28;
  groundX = 0;

  pipes.forEach(p=>p.remove());
  pipes = [];

  started = false;
  gameOver = false;
  bird.classList.remove("dead");
  game.classList.remove("hit");

  scoreEl.innerText = `0 | Best: ${best}`;
  title.innerText = "Flappy Trym";
  finalScore.innerText = "";
  actionBtn.innerText = "B·∫ÆT ƒê·∫¶U CH∆†I TRYM";
  overlay.style.display = "flex";
}

function startGame(){
  started = true;
  overlay.style.display = "none";

  bgMusic.currentTime = 0; // reset
  bgMusic.play();         // üîä PH√ÅT NH·∫†C

  pipeTimer = setInterval(createPipe,1500);
  loop();
}


function jump(){
  if(!started || gameOver) return;
  velocity = -8;
}

addEventListener("click", jump);
addEventListener("touchstart", jump);
addEventListener("keydown", e=>{
  if(e.code==="Space") jump();
});

actionBtn.onclick = ()=>{
  if(!started) startGame();
  else restart();
};

function createPipe(){
  const gap = innerHeight * gapRatio;
  const topH = Math.random() *
    (innerHeight - gap - 112 - 140) + 70;

  const pipeId = Date.now(); // ID cho c·∫∑p ·ªëng

  ["top","bottom"].forEach(type=>{
    const p = document.createElement("div");
    p.className = "pipe " + type;
    p.dataset.pipeId = pipeId;
    p.scored = false;

    p.style.height =
      type==="top" ? topH+"px" :
      (innerHeight - topH - gap - 112)+"px";
    p.style.left = innerWidth + "px";
    game.appendChild(p);
    pipes.push(p);
  });
}

function updatePipes(){
  pipes.forEach(p=>{
    let x = (parseFloat(p.style.left)||0) - pipeSpeed;
    p.style.left = x + "px";

    /* +1 ƒêI·ªÇM DUY NH·∫§T KHI QUA ·ªêNG TR√äN */
    if(
      p.classList.contains("top") &&
      !p.scored &&
      x + 52 < bird.offsetLeft
    ){
      p.scored = true;
      score++;

      if(score % 5 === 0){
        pipeSpeed += 0.3;
        gapRatio = Math.max(0.18, gapRatio - 0.015);
      }
      scoreEl.innerText = `${score} | Best: ${best}`;
    }

    if(hit(p)) endGame();

    if(x < -80){
      p.remove();
      pipes = pipes.filter(pipe => pipe !== p);
    }
  });
}

function hit(pipe){
  const b = bird.getBoundingClientRect();
  const p = pipe.getBoundingClientRect();
  return !(b.right<p.left||b.left>p.right||b.bottom<p.top||b.top>p.bottom);
}

function endGame(){
  if(gameOver) return;
  gameOver = true;
  clearInterval(pipeTimer);
bgMusic.pause();
  game.classList.add("hit");
  bird.classList.add("dead");

  if(score > best){
    best = score;
    localStorage.setItem("bestScore", best);
  }

  title.innerText = "SAO NON V·∫¨Y KKK";
  finalScore.innerText = `Score: ${score}\nBest: ${best}`;
  actionBtn.innerText = "Ch∆°i L·∫°i";
  overlay.style.display = "flex";
}

function restart(){
  init();
}

function loop(){
  if(gameOver) return;

  velocity += 0.45;
  birdY += velocity;

  if(birdY < 0) birdY = 0;
  if(birdY + 24 > innerHeight - 112){
    endGame(); return;
  }

  bird.style.top = birdY + "px";

  groundX -= pipeSpeed;
  ground.style.backgroundPositionX = groundX + "px";

  updatePipes();
  requestAnimationFrame(loop);
}

init();
</script>

</body>
</html>
